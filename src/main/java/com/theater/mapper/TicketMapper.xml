<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.theater.mapper.TicketMapper">

<select id="movieList" resultType="com.theater.domain.MovieVO"> <!-- 예매화면 영화 리스트 -->
  SELECT
  DISTINCT (F.M_CD) AS M_CD ,M.TITLE,M.RATE 
  FROM MOVIES M, FILMS F
  WHERE M.M_CD = F.M_CD
  AND F.FILM_STATUS = 1
</select>


<select id="getAreaSelect" resultType="com.theater.domain.ReserveVO"> <!-- 지역 리스트 -->
  SELECT
    DISTINCT(A.AREA_NAME),F.M_CD,T_AREA 
  FROM FILMS F, SCREENS S, THEATERS T,AREAINFO A
  WHERE F.SCREEN_CD = S.SCREEN_CD 
  AND S.T_CD = T.T_CD
  AND T.T_AREA = A.AREA_CD
  AND F.M_CD = #{m_cd}
  AND F.FILM_STATUS = 1
</select>

<select id="getTheaterSelect" resultType="com.theater.domain.ReserveVO"> <!--영화관 리스트 -->     
  SELECT
    DISTINCT (T.T_AREA) AS T_AREA ,F.M_CD,T.T_NAME,T.T_CD
  FROM FILMS F, SCREENS S, THEATERS T,AREAINFO A
  WHERE F.SCREEN_CD = S.SCREEN_CD 
  AND S.T_CD = T.T_CD
  AND T.T_AREA = A.AREA_CD
  AND T.T_AREA = #{t_area}
  AND F.M_CD = #{m_cd}
  AND F.FILM_STATUS = 1
</select>
<select id="getDaySelect" resultType="com.theater.domain.ReserveVO"> 
 SELECT
    (T.T_SEAT/T.T_SCREEN) AS T_SEAT, TO_CHAR(ft.start_time,'HH24:MI') AS START_TIME, S_T_CD 
    FROM FILMS F, SCREENS S, THEATERS T, FILM_TIMETABLE FT
    WHERE S.SCREEN_CD =  F.SCREEN_CD 
    AND S.T_CD = T.T_CD
    AND F.SCREEN_CD  = S.SCREEN_CD 
    AND F.FILM_CD = FT.FILM_CD 
    AND T.T_NAME = #{t_name}
    AND F.M_CD = #{m_cd}
    AND TO_CHAR(FT.start_time,'yyyy-MM-dd') = #{start_time}
    AND F.FILM_STATUS = 1
</select>

<select id="getReserveInfo" resultType="com.theater.domain.ReserveInsertVO"> 
 SELECT
  DISTINCT (SELECT MAX(TKT_CD) FROM TICKETINGS WHERE tk.ID= #{id} ) AS TKT_CD
  ,S_T_CD
FROM TICKETINGS tk
WHERE tk.ID= #{id}
AND tk.S_T_CD =#{s_t_cd}
</select>

 <insert id="reserve">
   <selectKey keyProperty="tkt_cd" order="BEFORE" resultType="int">
     SELECT TKT_SEQ.NEXTVAL FROM DUAL
   </selectKey>
     INSERT INTO TICKETINGS (TKT_CD,ID,S_T_CD,M_CD,TKT_DATE,TKT_TIME) VALUES (#{tkt_cd}, #{id}, #{s_t_cd}, #{m_cd}, #{tkt_date}, #{tkt_time})
  </insert> 
  
  <insert id="seatFix" parameterType="java.util.List">
    <selectKey keyProperty="sold_cd" order="BEFORE"  resultType="int">
      select sold_seq.nextval from dual
    </selectKey>
     insert into sold_seats(sold_cd, s_t_cd, tkt_cd,seat_price,seat_cd)
      select sold_seq.nextval,A.* from( 
    <foreach collection="seatList" item="item" index="index" separator="union all">
    select
      #{s_t_cd} as s_t_cd, #{tkt_cd} as tkt_cd, #{seat_price} as seat_price, #{item} as seat_cd
      from dual
    </foreach>) A
  </insert>    
  
<select id="getTkInfo" resultType="com.theater.domain.SelectSeatVO"> 
  
  SELECT * 
  FROM TICKETINGS t, MOVIES m  
  WHERE t.M_CD = m.M_CD  
  AND tkt_cd =#{tkt_cd} 
</select>

<select id="getTkList" resultType="com.theater.domain.TicketListVO"> 
  SELECT * 
  FROM TICKETINGS t, MOVIES m  
  WHERE t.M_CD = m.M_CD
</select>

</mapper>
