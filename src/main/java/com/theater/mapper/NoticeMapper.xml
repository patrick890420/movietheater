<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.theater.mapper.NoticeMapper">

<sql id="criteria">
<!-- class 이름과 같아야 함 -->
  <!-- 동적 sql/  sql태그: 반복 -->

<!-- 제거/  접두사/  접미사/  아래 where 다음에"("시작       "OR"로 시작하는  문장이 있으면 제거 -->  
  <trim prefix="(" suffix=") AND" prefixOverrides="OR">
    <foreach item="type" collection="typeArr">
            <!-- Criteria->이름 같으면 getTypeArr(자동 호출) 실행 -->
      <trim prefix="OR">
        <choose>
          <when test="type== 'T'.toString()">
            title like '%'||#{keyword}||'%'
          </when>
          <when test="type== 'C'.toString()">
            content like '%'||#{keyword}||'%'
          </when>
          <when test="type== 'W'.toString()">
            writer like '%'||#{keyword}||'%'
          </when>
        </choose>
      </trim>
    </foreach>
  </trim>
</sql>

<!-- 삽입 -->
<insert id="insert">
  <selectKey keyProperty="nt_cd" order="BEFORE" resultType="int">
    select notice_seq.nextval from dual
  </selectKey>
  insert into notice (nt_cd,title,e_img,content,wdate,hits)
  values (#{nt_cd},#{e_img},#{content},#{hits},sysdate,0)
</insert>

<!-- page 기법 처리/ 해당 페이지 검색 -->
<select id="getListWithPaging" resultType="com.theater.domain.NoticeVO">
  <![CDATA[
  select * from(
  select /*+ index_desc(notice SYS_C008071)*/ rownum rn, nt_cd,title,e_img,content,wdate,hits
  from notice
  where
    ]]>
    
  <include refid="criteria"/> <!-- 반복실행 문장 -->

  <![CDATA[
  rownum <= #{pageNum} * #{amount}
  ) where rn > (#{pageNum}-1)*#{amount}
  ]]>
</select>

<!--  검색을 도와줌 -->
  <select id="getList" resultType="com.theater.domain.NoticeVO">
<!--            검색된 결과를 noticeVO에 담는다     DB검색된 결과를 받는다 -->
  <![CDATA[
    select * from notice where nt_cd >0
    ]]>
  </select>
  
  
<!--  검색 결과 -->
<select id="read" resultType="com.theater.domain.NoticeVO">
  select * from notice where nt_cd= #{nt_cd}
</select>

<!-- page -->
<select id="nextPage" resultType="com.theater.domain.NoticeVO">
  <![CDATA[
    select * from notice where nt_cd< #{nt_cd} and rownum=1 order by nt_cd desc
    ]]>                   <!-- 오라클 페이지 기법 -->
</select>
<select id="prevPage" resultType="com.theater.domain.NoticeVO">
  <![CDATA[
    select * from notice where nt_cd> #{nt_cd} and rownum=1 order by nt_cd asc
    ]]>
</select>

<!-- 조회수 -->
<update id="readCount">
  update notice set hits= hits+ 1 where nt_cd= #{nt_cd}
</update>
  
  
<!-- 전체 래코드 갯수 -->
<select id="getTotalCount" resultType="int">
  select count(*) from notice where
    <include refid="criteria"></include>
   nt_cd > 0
</select>


</mapper>
